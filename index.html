<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ChatBot UI - GPT-4o, ì›¹ ê²€ìƒ‰, ì´ë¯¸ì§€ ìƒì„±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .feature-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .feature-desc {
            font-size: 0.9rem;
            color: #666;
        }
        
        .api-key-section {
            margin: 30px 0;
        }
        
        .api-key-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        .api-key-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
        }
        
        .start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .github-link {
            margin-top: 30px;
        }
        
        .github-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }
        
        .github-link a:hover {
            text-decoration: underline;
        }
        
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ¤– AI ChatBot UI</div>
        <div class="subtitle">
            GPT-4o, ì›¹ ê²€ìƒ‰, ì´ë¯¸ì§€ ìƒì„±ì´ í†µí•©ëœ ì˜¬ì¸ì› AI ì–´ì‹œìŠ¤í„´íŠ¸
        </div>
        
        <div class="features">
            <div class="feature">
                <div class="feature-icon">ğŸ§ </div>
                <div class="feature-title">GPT-4o ëŒ€í™”</div>
                <div class="feature-desc">ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´/ì˜ì–´ ëŒ€í™”</div>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ¨</div>
                <div class="feature-title">ì´ë¯¸ì§€ ìƒì„±</div>
                <div class="feature-desc">DALL-E 3ìœ¼ë¡œ ê³ í’ˆì§ˆ ì´ë¯¸ì§€</div>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ”</div>
                <div class="feature-title">ì›¹ ê²€ìƒ‰</div>
                <div class="feature-desc">ì‹¤ì‹œê°„ ì •ë³´ ê²€ìƒ‰</div>
            </div>
        </div>
        
        <div class="api-key-section">
            <input type="password" 
                   class="api-key-input" 
                   id="apiKey" 
                   placeholder="OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (sk-...)"
                   autocomplete="off">
            <button class="start-btn" id="startBtn" onclick="validateAndStart()">
                ì±„íŒ… ì‹œì‘í•˜ê¸°
            </button>
        </div>
        
        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
            <h4 style="margin: 0 0 10px 0; color: #28a745;">ğŸ” ê²€ìƒ‰ ê¸°ëŠ¥</h4>
            <p style="margin: 0 0 10px 0; font-size: 14px; color: #6c757d;">
                ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ì„ í†µí•´ ìµœì‹  ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!
            </p>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="github-link">
            <a href="https://github.com/muniv/chatgpt_test" target="_blank">
                ğŸ“ GitHub ì €ì¥ì†Œ ë³´ê¸°
            </a>
        </div>
    </div>

    <script>
        const apiKeyInput = document.getElementById('apiKey');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        
        // API í‚¤ ì…ë ¥ ì‹œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        apiKeyInput.addEventListener('input', function() {
            startBtn.disabled = !this.value.trim();
        });
        
        // Enter í‚¤ë¡œ ì‹œì‘
        apiKeyInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                validateAndStart();
            }
        });
        
        async function validateAndStart() {
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showStatus('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showStatus('ì˜¬ë°”ë¥¸ OpenAI API í‚¤ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.', 'error');
                return;
            }
            
            startBtn.disabled = true;
            startBtn.textContent = 'ê²€ì¦ ì¤‘...';
            
            try {
                // API í‚¤ ìœ íš¨ì„± ê²€ì‚¬
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (response.ok) {
                    // API í‚¤ë¥¼ localStorageì— ì €ì¥
                    localStorage.setItem('openai_api_key', apiKey);
                    showStatus('API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤! ì±„íŒ…ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'success');
                    
                    // ê°„ë‹¨í•œ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ë¡œ ì´ë™
                    setTimeout(() => {
                        startChat(apiKey);
                    }, 1000);
                } else {
                    showStatus('ìœ íš¨í•˜ì§€ ì•Šì€ API í‚¤ì…ë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                }
            } catch (error) {
                showStatus('API í‚¤ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = 'ì±„íŒ… ì‹œì‘í•˜ê¸°';
            }
        }
        
        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
                 // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥
         let conversationHistory = [
             {
                 role: 'system',
                 content: 'ë‹¹ì‹ ì€ ë„ì›€ì´ ë˜ê³  ì¹œê·¼í•œ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.'
             },
             {
                 role: 'assistant',
                 content: 'ì•ˆë…•í•˜ì„¸ìš”! API í‚¤ë¡œ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?'
             }
         ];
         
         // ëŒ€í™” íˆìŠ¤í† ë¦¬ ê¸¸ì´ ì œí•œ (ìµœëŒ€ 20ê°œ ë©”ì‹œì§€)
         function limitConversationHistory() {
             const maxMessages = 20;
             if (conversationHistory.length > maxMessages) {
                 // system ë©”ì‹œì§€ì™€ ì²« ë²ˆì§¸ assistant ë©”ì‹œì§€ëŠ” ìœ ì§€
                 const systemMessage = conversationHistory[0];
                 const firstAssistantMessage = conversationHistory[1];
                 const recentMessages = conversationHistory.slice(-(maxMessages - 2));
                 conversationHistory = [systemMessage, firstAssistantMessage, ...recentMessages];
             }
         }
         
         function startChat(apiKey) {
             // ê°„ë‹¨í•œ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ ìƒì„±
             const container = document.querySelector('.container');
             container.innerHTML = `
                 <div class="logo">ğŸ’¬ AI ì±„íŒ…</div>
                 <div style="text-align: left; margin: 20px 0;">
                     <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                         <strong>AI:</strong> ì•ˆë…•í•˜ì„¸ìš”! API í‚¤ë¡œ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                     </div>
                 </div>
                 <div style="display: flex; gap: 10px;">
                     <input type="text" 
                            id="messageInput" 
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            style="flex: 1; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px;">
                     <button onclick="sendMessage()" 
                             style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                         ì „ì†¡
                     </button>
                     <button onclick="searchAndChat()" 
                             style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                         ğŸ” ê²€ìƒ‰
                     </button>
                 </div>
                 <div id="chatMessages" style="text-align: left; margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
                 <button onclick="location.reload()" 
                         style="margin-top: 20px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                     ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                 </button>
             `;
             
             // ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸
             const messageInput = document.getElementById('messageInput');
             messageInput.addEventListener('keypress', function(e) {
                 if (e.key === 'Enter') {
                     sendMessage();
                 }
             });
         }
        
                 async function sendMessage() {
             const messageInput = document.getElementById('messageInput');
             const chatMessages = document.getElementById('chatMessages');
             const message = messageInput.value.trim();
             
             if (!message) return;
             
             const apiKey = localStorage.getItem('openai_api_key');
             
             // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
             conversationHistory.push({
                 role: 'user',
                 content: message
             });
             
             // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
             chatMessages.innerHTML += `
                 <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                     <strong>ì‚¬ìš©ì:</strong> ${message}
                 </div>
             `;
             
             messageInput.value = '';
             messageInput.disabled = true;
             
             // ì´ë¯¸ì§€ ìƒì„± í‚¤ì›Œë“œ ê°ì§€ (ë” ì •í™•í•˜ê²Œ)
             const imageKeywords = ['ê·¸ë ¤ì¤˜', 'ê·¸ë ¤', 'ê·¸ë ¤ë´', 'draw', 'generate'];
             const hasImageKeyword = imageKeywords.some(keyword => 
                 message.toLowerCase().includes(keyword.toLowerCase())
             );
             
             console.log('ë©”ì‹œì§€:', message);
             console.log('ì´ë¯¸ì§€ í‚¤ì›Œë“œ ê°ì§€:', hasImageKeyword);
             
             try {
                 if (hasImageKeyword) {
                     console.log('ì´ë¯¸ì§€ ìƒì„± ì‹œì‘');
                     // ì´ë¯¸ì§€ ìƒì„±
                     await generateImage(message, apiKey, chatMessages);
                 } else {
                     console.log('í…ìŠ¤íŠ¸ ì‘ë‹µ ì‹œì‘');
                     // ì¼ë°˜ ëŒ€í™”
                     await generateTextResponse(message, apiKey, chatMessages);
                 }
             } catch (error) {
                 console.error('ì˜¤ë¥˜:', error);
                 chatMessages.innerHTML += `
                     <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                         <strong>ì˜¤ë¥˜:</strong> ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                     </div>
                 `;
             } finally {
                 messageInput.disabled = false;
                 messageInput.focus();
                 chatMessages.scrollTop = chatMessages.scrollHeight;
             }
         }
         
         async function generateTextResponse(message, apiKey, chatMessages) {
             const response = await fetch('https://api.openai.com/v1/chat/completions', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                     'Authorization': `Bearer ${apiKey}`
                 },
                 body: JSON.stringify({
                     model: 'gpt-4o',
                     messages: conversationHistory,
                     max_tokens: 1000,
                     temperature: 0.7
                 })
             });
             
             if (response.ok) {
                 const data = await response.json();
                 const aiResponse = data.choices[0].message.content;
                 
                 // AI ì‘ë‹µì„ ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                 conversationHistory.push({
                     role: 'assistant',
                     content: aiResponse
                 });
                 
                 // ëŒ€í™” íˆìŠ¤í† ë¦¬ ê¸¸ì´ ì œí•œ
                 limitConversationHistory();
                 
                 chatMessages.innerHTML += `
                     <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                         <strong>AI:</strong> ${aiResponse}
                     </div>
                 `;
             } else {
                 throw new Error('í…ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨');
             }
         }
         
         async function generateImage(message, apiKey, chatMessages) {
             console.log('ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜ ì‹œì‘:', message);
             
             // ì´ë¯¸ì§€ ìƒì„± ì¤‘ í‘œì‹œ
             chatMessages.innerHTML += `
                 <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                     <strong>AI:</strong> ğŸ¨ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                 </div>
             `;
             
             // í”„ë¡¬í”„íŠ¸ì—ì„œ ì´ë¯¸ì§€ í‚¤ì›Œë“œ ì œê±°í•˜ê³  ì‹¤ì œ ë‚´ìš©ë§Œ ì¶”ì¶œ
             let prompt = message;
             const imageKeywords = ['ê·¸ë ¤ì¤˜', 'ê·¸ë ¤', 'ê·¸ë ¤ë´'];
             imageKeywords.forEach(keyword => {
                 prompt = prompt.replace(new RegExp(keyword, 'gi'), '').trim();
             });
             
             // ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ê°œì„ 
             let enhancedPrompt = prompt;
             
             // ëŒ€í™” íˆìŠ¤í† ë¦¬ì—ì„œ ê´€ë ¨ ë‚´ìš© ì¶”ì¶œ
             const recentMessages = conversationHistory.slice(-6); // ìµœê·¼ 6ê°œ ë©”ì‹œì§€ í™•ì¸
             const contextMessages = recentMessages.filter(msg => 
                 msg.role === 'user' && 
                 !imageKeywords.some(keyword => msg.content.toLowerCase().includes(keyword.toLowerCase()))
             );
             
             if (contextMessages.length > 0) {
                 // ì´ì „ ëŒ€í™” ë‚´ìš©ì„ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€
                 const contextText = contextMessages.map(msg => msg.content).join(' ');
                 enhancedPrompt = `${contextText} ${prompt}`;
                 console.log('ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ í¬í•¨ëœ í”„ë¡¬í”„íŠ¸:', enhancedPrompt);
             }
             
             console.log('ì¶”ì¶œëœ í”„ë¡¬í”„íŠ¸:', prompt);
             
             // í•œêµ­ì–´ë¥¼ ì˜ì–´ë¡œ ë²ˆì—­ (ê°„ë‹¨í•œ ë§¤í•‘)
             const translations = {
                 'ê³ ì–‘ì´': 'cat',
                 'ê°•ì•„ì§€': 'dog',
                 'ì‚¬ëŒ': 'person',
                 'í’ê²½': 'landscape',
                 'ê½ƒ': 'flower',
                 'ë‚˜ë¬´': 'tree',
                 'í•˜ëŠ˜': 'sky',
                 'ë°”ë‹¤': 'ocean',
                 'ì‚°': 'mountain',
                 'ì§‘': 'house',
                 'ìë™ì°¨': 'car',
                 'ë¹„í–‰ê¸°': 'airplane',
                 'ë°°': 'ship',
                 'ì±…': 'book',
                 'ì»´í“¨í„°': 'computer',
                 'ì „í™”': 'phone',
                 'ìŒì‹': 'food',
                 'ìŒì•…': 'music',
                 'ìš´ë™': 'exercise',
                 'ê²Œì„': 'game'
             };
             
             // ë²ˆì—­ ì ìš©
             let englishPrompt = enhancedPrompt;
             Object.keys(translations).forEach(korean => {
                 englishPrompt = englishPrompt.replace(new RegExp(korean, 'g'), translations[korean]);
             });
             
             // ì˜ì–´ í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì›ë³¸ ì‚¬ìš©
             if (!englishPrompt.trim()) {
                 englishPrompt = enhancedPrompt;
             }
             
             console.log('ì˜ì–´ í”„ë¡¬í”„íŠ¸:', englishPrompt);
             
             try {
                 // DALL-E API í˜¸ì¶œ
                 const apiResponse = await fetch('https://api.openai.com/v1/images/generations', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${apiKey}`
                     },
                     body: JSON.stringify({
                         model: 'dall-e-3',
                         prompt: englishPrompt + ' (high quality, detailed, beautiful)',
                         n: 1,
                         size: '1024x1024'
                     })
                 });
                 
                 console.log('DALL-E API ì‘ë‹µ ìƒíƒœ:', apiResponse.status);
                 
                 if (apiResponse.ok) {
                     const imageData = await apiResponse.json();
                     console.log('ì´ë¯¸ì§€ ë°ì´í„°:', imageData);
                     
                     const imageUrl = imageData.data[0].url;
                     
                     // ê¸°ì¡´ "ìƒì„± ì¤‘" ë©”ì‹œì§€ ì œê±°
                     const lastMessage = chatMessages.lastElementChild;
                     if (lastMessage && lastMessage.textContent.includes('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤')) {
                         lastMessage.remove();
                     }
                     
                     // AI ì‘ë‹µì„ ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                     const imageResponseText = `ğŸ¨ "${enhancedPrompt}"ì— ëŒ€í•œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤!`;
                     conversationHistory.push({
                         role: 'assistant',
                         content: imageResponseText
                     });
                     
                     // ëŒ€í™” íˆìŠ¤í† ë¦¬ ê¸¸ì´ ì œí•œ
                     limitConversationHistory();
                     
                     // ìƒì„±ëœ ì´ë¯¸ì§€ í‘œì‹œ
                     chatMessages.innerHTML += `
                         <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                             <strong>AI:</strong> ğŸ¨ "${enhancedPrompt}"ì— ëŒ€í•œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤!<br><br>
                             <img src="${imageUrl}" alt="AI ìƒì„± ì´ë¯¸ì§€" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                         </div>
                     `;
                 } else {
                     const errorData = await apiResponse.json();
                     console.error('DALL-E API ì˜¤ë¥˜:', errorData);
                     throw new Error(`ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ${errorData.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                 }
             } catch (error) {
                 console.error('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                 
                 // ê¸°ì¡´ "ìƒì„± ì¤‘" ë©”ì‹œì§€ ì œê±°
                 const lastMessage = chatMessages.lastElementChild;
                 if (lastMessage && lastMessage.textContent.includes('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤')) {
                     lastMessage.remove();
                 }
                 
                 // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                 chatMessages.innerHTML += `
                     <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                         <strong>ì˜¤ë¥˜:</strong> ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                     </div>
                 `;
             }
                  }
         
         // ê²€ìƒ‰ ê¸°ëŠ¥
         async function searchAndChat() {
             const messageInput = document.getElementById('messageInput');
             const chatMessages = document.getElementById('chatMessages');
             const message = messageInput.value.trim();
             
             if (!message) {
                 alert('ê²€ìƒ‰í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                 return;
             }
             
             const apiKey = localStorage.getItem('openai_api_key');
             
             // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
             conversationHistory.push({
                 role: 'user',
                 content: `ğŸ” ${message} (ê²€ìƒ‰ ìš”ì²­)`
             });
             
             // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
             chatMessages.innerHTML += `
                 <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                     <strong>ì‚¬ìš©ì:</strong> ğŸ” ${message} (ê²€ìƒ‰ ìš”ì²­)
                 </div>
             `;
             
             messageInput.value = '';
             messageInput.disabled = true;
             
             try {
                 // ê²€ìƒ‰ ì¤‘ í‘œì‹œ
                 chatMessages.innerHTML += `
                     <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                         <strong>AI:</strong> ğŸ” ì›¹ì—ì„œ "${message}"ì— ëŒ€í•œ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                     </div>
                 `;
                 
                 // ì›¹ ê²€ìƒ‰ ìˆ˜í–‰ (SerpAPI ì‚¬ìš©)
                 const searchResults = await performWebSearch(message);
                 
                 // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ AI ì‘ë‹µ ìƒì„±
                 await generateSearchResponse(message, searchResults, apiKey, chatMessages);
                 
             } catch (error) {
                 console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                 
                 // ê¸°ì¡´ "ê²€ìƒ‰ ì¤‘" ë©”ì‹œì§€ ì œê±°
                 const lastMessage = chatMessages.lastElementChild;
                 if (lastMessage && lastMessage.textContent.includes('ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤')) {
                     lastMessage.remove();
                 }
                 
                 chatMessages.innerHTML += `
                     <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                         <strong>ì˜¤ë¥˜:</strong> ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                     </div>
                 `;
             } finally {
                 messageInput.disabled = false;
                 messageInput.focus();
                 chatMessages.scrollTop = chatMessages.scrollHeight;
             }
         }
         

         
         // ì›¹ ê²€ìƒ‰ ìˆ˜í–‰
         async function performWebSearch(query) {
             console.log('ê²€ìƒ‰ ì¿¼ë¦¬:', query);
             
             // ê³ ì •ëœ SerpAPI í‚¤ ì‚¬ìš©
             const serpApiKey = '58916791d803e313587e30c1a529acd6e64b9fd6e51104459425eeae6c576bf2';
             
             // ì‹¤ì œ SerpAPI ì‚¬ìš©
             try {
                 const response = await fetch(`https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(query)}&api_key=${serpApiKey}&num=5`);
                 
                 if (response.ok) {
                     const data = await response.json();
                     console.log('SerpAPI ê²€ìƒ‰ ê²°ê³¼:', data);
                     
                     if (data.organic_results && data.organic_results.length > 0) {
                         return data.organic_results.slice(0, 5).map(result => ({
                             title: result.title,
                             snippet: result.snippet,
                             link: result.link
                         }));
                     }
                 } else {
                     console.error('SerpAPI ì˜¤ë¥˜:', response.status);
                     const errorData = await response.json();
                     console.error('SerpAPI ì˜¤ë¥˜ ìƒì„¸:', errorData);
                 }
             } catch (error) {
                 console.error('SerpAPI í˜¸ì¶œ ì˜¤ë¥˜:', error);
             }
             
             // SerpAPI ì˜¤ë¥˜ ë°œìƒ ì‹œ ì‹œë®¬ë ˆì´ì…˜ëœ ê²°ê³¼ ë°˜í™˜
             const mockSearchResults = [
                 {
                     title: `${query}ì— ëŒ€í•œ ìµœì‹  ì •ë³´`,
                     snippet: `${query}ì— ëŒ€í•œ ìƒì„¸í•œ ì •ë³´ì™€ ìµœì‹  ë™í–¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
                     link: `https://www.google.com/search?q=${encodeURIComponent(query)}`
                 },
                 {
                     title: `${query} ê´€ë ¨ ë‰´ìŠ¤`,
                     snippet: `${query}ì™€ ê´€ë ¨ëœ ìµœì‹  ë‰´ìŠ¤ì™€ ì—…ë°ì´íŠ¸ ì •ë³´ì…ë‹ˆë‹¤.`,
                     link: `https://news.google.com/search?q=${encodeURIComponent(query)}`
                 },
                 {
                     title: `${query} ì „ë¬¸ ìë£Œ`,
                     snippet: `${query}ì— ëŒ€í•œ ì „ë¬¸ì ì¸ ë¶„ì„ê³¼ ìë£Œë¥¼ ì œê³µí•©ë‹ˆë‹¤.`,
                     link: `https://scholar.google.com/scholar?q=${encodeURIComponent(query)}`
                 }
             ];
             
             return mockSearchResults;
         }
         
         // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ AI ì‘ë‹µ ìƒì„±
         async function generateSearchResponse(query, searchResults, apiKey, chatMessages) {
             // ê²€ìƒ‰ ê²°ê³¼ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
             const searchText = searchResults.map((result, index) => 
                 `${index + 1}. ${result.title}\n   ${result.snippet}\n   ë§í¬: ${result.link}`
             ).join('\n\n');
             
             // ê¸°ì¡´ "ê²€ìƒ‰ ì¤‘" ë©”ì‹œì§€ ì œê±°
             const lastMessage = chatMessages.lastElementChild;
             if (lastMessage && lastMessage.textContent.includes('ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤')) {
                 lastMessage.remove();
             }
             
             try {
                 const response = await fetch('https://api.openai.com/v1/chat/completions', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${apiKey}`
                     },
                     body: JSON.stringify({
                         model: 'gpt-4o',
                         messages: [
                             {
                                 role: 'system',
                                 content: `ë‹¹ì‹ ì€ ì›¹ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ ì œê³µí•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. 
                                 ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìš”ì•½í•˜ê³ , ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”. 
                                 í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ê³ , ê²€ìƒ‰ ê²°ê³¼ì˜ ì¶œì²˜ë¥¼ ì–¸ê¸‰í•˜ì„¸ìš”.`
                             },
                             {
                                 role: 'user',
                                 content: `ë‹¤ìŒì€ "${query}"ì— ëŒ€í•œ ì›¹ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤:\n\n${searchText}\n\nì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ "${query}"ì— ëŒ€í•´ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”.`
                             }
                         ],
                         max_tokens: 1500,
                         temperature: 0.7
                     })
                 });
                 
                 if (response.ok) {
                     const data = await response.json();
                     const aiResponse = data.choices[0].message.content;
                     
                     // AI ì‘ë‹µì„ ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                     conversationHistory.push({
                         role: 'assistant',
                         content: `ğŸ” "${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ë“œë¦½ë‹ˆë‹¤:\n\n${aiResponse}`
                     });
                     
                     // ëŒ€í™” íˆìŠ¤í† ë¦¬ ê¸¸ì´ ì œí•œ
                     limitConversationHistory();
                     
                     chatMessages.innerHTML += `
                         <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                             <strong>AI:</strong> ğŸ” "${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ë“œë¦½ë‹ˆë‹¤:<br><br>
                             ${aiResponse.replace(/\n/g, '<br>')}
                         </div>
                     `;
                 } else {
                     throw new Error('AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨');
                 }
             } catch (error) {
                 console.error('AI ì‘ë‹µ ìƒì„± ì˜¤ë¥˜:', error);
                 
                 // ê²€ìƒ‰ ê²°ê³¼ë§Œ í‘œì‹œ
                 chatMessages.innerHTML += `
                     <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                         <strong>AI:</strong> ğŸ” "${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤:<br><br>
                         ${searchResults.map((result, index) => 
                             `<strong>${index + 1}. ${result.title}</strong><br>
                             ${result.snippet}<br>
                             <a href="${result.link}" target="_blank" style="color: #667eea;">ë§í¬ ë³´ê¸°</a><br><br>`
                         ).join('')}
                     </div>
                 `;
             }
         }
     </script>
</body>
</html> 